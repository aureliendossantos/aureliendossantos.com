---
import { getEntry, type CollectionEntry } from "astro:content"
import BaseLayout from "./BaseLayout.astro"
import getPalette, { getColor } from "$utils/design/palettes"
import ArticleHeader from "$components/articles/ArticleHeader.astro"
import TableOfContents from "$components/articles/TableOfContents.astro"
import type { MarkdownHeading } from "astro"
import "$styles/hyphenation.css"
import "$styles/articles.css"
import "$styles/tufte.css"
import { Layouts } from "$utils/design/layouts"
import getRelatedArticles from "$utils/getRelatedArticles"
import TufteHeader from "$components/articles/TufteHeader.astro"
import NavbarAccessFooter from "$components/navbar/NavbarAccessFooter.astro"
import getSeeAlso from "$utils/getSeeAlso"

interface Props {
	article: CollectionEntry<"blog"> | CollectionEntry<"pages">
	headings: MarkdownHeading[]
}

const { article, headings } = Astro.props
const data = article.data
const date = "date" in data ? data.date : undefined
const wide = "categories" in data && data.categories.includes("Photos")
// Alternative layouts
const customLayout = data.customLayout
const cormorant = data.layouts?.includes(Layouts.cormorant)
const tufte = data.layouts?.includes(Layouts.tufte)
const tufteHtml = (await Astro.slots.render("default")).replaceAll(
	"<section-switch></section-switch>",
	"</section><section>"
)
// Images
const ogImage = data.opengraph || data.image
const coverImage = data.cover && data.image ? data.image : undefined
const palette = getPalette(data.palette)
// Related articles
const isBlog = "categories" in data
const relatedArticles = isBlog
	? (await getRelatedArticles(article as CollectionEntry<"blog">)).map((a) => ({
			title: a.article.data.title,
			href: `/${a.article.slug}`,
	  }))
	: await getSeeAlso(data.seeAlso)
const parent = !isBlog && data.parent && (await getEntry("pages", data.parent))
---

<BaseLayout
	ogType="article"
	title={data.title}
	description={data.description}
	date={date}
	image={ogImage?.src}
	bg={palette.bgColor}
	popupBorderColor={palette.popupBorderColor}
	popupLabelActiveBgColor={palette.popupLabelActiveBgColor}
	codeTheme={palette.codeTheme}
	paletteName={palette.name}
	layout={data.layouts}
	navBarProps={{
		title: data.title,
		parent: isBlog
			? { title: "Blog", href: "/" }
			: parent && { title: parent.data.title, href: `/${parent.slug}` },
		related: relatedArticles,
		relatedTitle: isBlog ? "Articles similaires" : "Voir aussi",
		headings: headings,
	}}
>
	<div
		class="article-styling"
		style={{
			"--base-color": getColor(palette.baseColor),
			"--dark-base-color": getColor(palette.baseColor, "dark"),
			"--secondary-color": getColor(palette.secondaryColor),
			"--dark-secondary-color": getColor(palette.secondaryColor, "dark"),
			"--special-color": getColor(palette.specialColor),
			"--dark-special-color": getColor(palette.specialColor, "dark"),
			"--bg-color": getColor(palette.bgColor),
			"--dark-bg-color": getColor(palette.bgColor, "dark"),
			"--bg-mention-color": getColor(palette.mentionBgColor),
			"--dark-bg-mention-color": getColor(palette.mentionBgColor, "dark"),
			"--bg-mention-hover-color": getColor(palette.mentionHoverBgColor),
			"--dark-bg-mention-hover-color": getColor(palette.mentionHoverBgColor, "dark"),
			"--base-font": palette.baseFont,
			"--code-font": palette.codeFont,
			"--font-size": palette.fontSize,
			"--sm-font-size": "16px",
			"--line-height": palette.lineHeight,
			"--sm-line-height": palette.lineHeight * 1.1,
			"--page-width": palette.pageWidth,
			"--internal-link-decoration": palette.internalLinks,
		}}
	>
		{
			!customLayout &&
				(tufte ? (
					<TufteHeader title={data.title} description={data.description} date={date} />
				) : (
					<ArticleHeader
						title={data.title}
						description={data.description}
						date={date}
						cover={coverImage}
						palette={palette}
						layouts={data.layouts}
						wide={wide}
						anchorTop={data.imageAnchorTop}
					/>
				))
		}
		{
			tufte ? (
				<div class="font-[family-name:--base-font] text-[length:--font-size] leading-[--line-height] text-[color:--base-color] small:text-[length:--sm-font-size] small:leading-[--sm-line-height] dark:text-[color:--dark-base-color]">
					<section set:html={tufteHtml} />
					<NavbarAccessFooter />
				</div>
			) : (
				<main
					class:list={{ "px-[80px] pb-16 medium:px-[40px] small:px-[20px]": !customLayout }}
					class="font-[family-name:--base-font] text-[length:--font-size] leading-[--line-height] text-[color:--base-color] small:text-[length:--sm-font-size] small:leading-[--sm-line-height] dark:text-[color:--dark-base-color]"
				>
					<div
						class:list={[
							{ "blog-article m-auto": !customLayout },
							{ "max-w-[--page-width]": !customLayout && !wide },
							{ "max-w-[700px]": wide },
						]}
					>
						{article.data.toc && <TableOfContents headings={headings} depth={article.data.depth} />}
						<slot />
						{!customLayout && <NavbarAccessFooter />}
					</div>
				</main>
			)
		}
	</div>
</BaseLayout>

<style
	define:vars={{ displayFont: palette.displayFont, headingsFont: palette.headingsFont }}
	is:global
>
	.article-styling {
		h1 {
			font-family: var(--displayFont);
		}
		h2,
		h3,
		h4,
		h5,
		h6 {
			font-family: var(--headingsFont);
		}
	}
</style>

