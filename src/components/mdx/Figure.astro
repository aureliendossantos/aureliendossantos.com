---
import Image from "$components/Image.astro"
import type { AstroBuiltinAttributes, ImageQuality } from "astro"

interface Props {
	src: ImageMetadata | Promise<{ default: ImageMetadata }>
	alt?: string
	caption?: string
	rounded?: boolean
	shadow?: boolean
	half?: boolean
	third?: boolean
	zoomQuality?: ImageQuality
}
const {
	src: srcToResolve,
	alt,
	caption,
	rounded,
	shadow,
	half,
	third,
	zoomQuality,
	...attributes
} = Astro.props

const src = "then" in srcToResolve ? (await srcToResolve).default : srcToResolve
const classes: AstroBuiltinAttributes["class:list"] = { "rounded-md": rounded, shadow: shadow }

function getMaxWidth() {
	if (third) return 640
	if (half) return 960
	return 1920
}

const width = Math.min(src.width, getMaxWidth())
---

<figure>
	<Image
		src={src}
		width={width}
		zoomQuality={zoomQuality}
		alt={alt || ""}
		class:list={classes}
		{...attributes}
	/>
	{
		Astro.slots.has("default") && (
			<figcaption>
				<div>
					<slot />
				</div>
			</figcaption>
		)
	}
	{
		caption && (
			<figcaption>
				<div>
					<slot>{caption}</slot>
				</div>
			</figcaption>
		)
	}
</figure>
