---
import RefBlock from "$components/RefBlock.astro"
import formatDate from "$utils/formatting/formatDate"

interface Props {
	isbn?: string
	olid?: string
}
const { isbn, olid } = Astro.props
// TODO: handle errors
const result = await fetch(
	`https://openlibrary.org/api/books?bibkeys=${
		isbn ? `ISBN:${isbn}` : `OLID:${olid}`
	}&jscmd=details&format=json`
).then((response) => response.json())
// Response format: https://openlibrary.org/dev/docs/api/books
const book: any = Object.values(result)[0]
const year = formatDate(new Date(book.details.publish_date), true)
const infos = []
if (book.details.subtitle) infos.push(book.details.subtitle)
if (book.details.authors)
	infos.push(book.details.authors.map((author: any) => author.name).join(", "))
infos.push(book.details.publishers ? `${book.details.publishers?.join(", ")} (${year})` : year)
const links = []
if (book.details.isbn_13)
	links.push([`<abbr>ISBN</abbr> ${book.details.isbn_13?.join(", ")}`, false])
links.push(["Open Library", book.info_url])
---

<RefBlock
	img={`https://covers.openlibrary.org/b/isbn/${isbn}-L.jpg`}
	title={book.details.title}
	infos={infos}
	links={links}
/>
