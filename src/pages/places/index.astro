---
import PlacesList from "$components/places/PlacesList.astro"
import { getCollection } from "astro:content"
import PlacesLayout from "$layouts/PlacesLayout.astro"
import { getPlacesData } from "scripts/remoteDataUtils"
import getBlogPosts from "$utils/getBlogPosts"

const googleMapsData = await getPlacesData()

const reviewsOrder = ["loved", "liked", "okay", null]
const articles = await getBlogPosts()

const places = (await getCollection("places"))
	.map((place) => ({
		...place,
		category: place.slug.split("/")[0],
		slug: place.slug.split("/")[1],
		maps: googleMapsData.find((p) => p.place_id == place.data.id),
		articles: articles.filter((a) => a.data.places.includes(place.slug)).length,
	}))
	.sort((a, b) => reviewsOrder.indexOf(a.data.review) - reviewsOrder.indexOf(b.data.review))
	.sort((a, b) => a.data.status.localeCompare(b.data.status))
	.sort((a, b) => a.maps.icon.localeCompare(b.maps.icon))
---

<PlacesLayout ogType="website" title="Lieux">
	<div class="m-auto flex max-w-xl flex-col gap-8 pt-10 text-zinc-900">
		<header class="flex justify-between px-8 font-work-sans text-sm text-zinc-400">
			<p>
				<a href="/" class="hover:text-amber-700">← Retour à l'accueil</a>
			</p>
		</header>
		<main class="flex flex-col">
			<header class="prose prose-zinc mb-8 px-8 small:prose-sm">
				<h1>Lieux</h1>
			</header>
			<PlacesList
				title="À Toulouse"
				places={places.filter((place) => place.category == "toulouse")}
			/>
			<PlacesList
				title="En Occitanie"
				places={places.filter((place) => place.category == "occitanie")}
			/>
			<PlacesList
				title="En Aquitaine"
				places={places.filter((place) => place.category == "aquitaine")}
			/>
			<PlacesList
				title="En Europe"
				places={places.filter((place) => place.category == "europe")}
			/>
		</main>
		<div id="map" class="h-[448px] w-full bg-zinc-200"></div>
	</div>
</PlacesLayout>
<!--
<script>
	let map: google.maps.Map
	function initMap() {
		map = new google.maps.Map(document.getElementById("map") as HTMLDivElement, {
			mapId: "531454af7b16b9f",
			center: { lat: 43.602, lng: 1.446 },
			zoom: 13,
		})
		const places = Array.from(
			document.getElementsByClassName("place") as HTMLCollectionOf<HTMLLinkElement>
		).map((place) => ({
			lat: Number(place.dataset.lat),
			lng: Number(place.dataset.lng),
			icon: place.dataset.icon,
			title: place.children[0].textContent,
			href: place.href,
		}))
		console.log(places)
		places.forEach((place) => {
			const contentString =
				'<div id="content">' +
				'<div id="siteNotice">' +
				"</div>" +
				`<h1 id="firstHeading" class="firstHeading">${place.title}</h1>` +
				'<div id="bodyContent">' +
				`<p><b><a href="${place.href}">Voir la page</a></b></p>` +
				"</div>" +
				"</div>"
			const infowindow = new google.maps.InfoWindow({
				content: contentString,
				ariaLabel: place.title,
			})
			const marker = new google.maps.Marker({
				position: { lat: place.lat, lng: place.lng },
				map,
				title: place.title,
				//icon: place.icon,
			})
			marker.addListener("click", () => {
				infowindow.open({
					anchor: marker,
					map,
				})
			})
		})
	}
	window.initMap = initMap
</script>

<script
	async
	src=`https://maps.googleapis.com/maps/api/js?key=${apiKey}&region=FR&language=fr&callback=initMap`
></script>
-->
