---
import PlacesList from "$components/places/PlacesList.astro"
import { getCollection } from "astro:content"
import DiaryLayout from "$layouts/DiaryLayout.astro"
import { type PlaceWithFetchDate, getPlacesData } from "$utils/remoteData/googleMaps"
import getBlogPosts, { getDiary } from "$utils/getCollection"
import InitMaps from "$components/places/InitMaps.astro"

const googleMapsData = await getPlacesData()

const reviewsOrder = ["loved", "liked", "okay", null]
const articles = await getBlogPosts()
const diaryEntries = await getDiary()

const places = (await getCollection("places", ({ data }) => !data.hide))
	.map((place) => ({
		...place,
		category: place.slug.split("/")[0],
		slug: place.slug.split("/")[1],
		maps: googleMapsData.find((p) => p.place_id == place.data.id) as PlaceWithFetchDate,
		articles: articles.filter((a) => a.data.places.includes(place.slug)).length,
		diaryEntries: diaryEntries.filter((a) => a.data.places.includes(place.slug)).length,
	}))
	.sort(
		(a, b) =>
			reviewsOrder.indexOf(a.data.review || null) - reviewsOrder.indexOf(b.data.review || null)
	)
	.sort((a, b) => a.data.status.localeCompare(b.data.status))
	.sort((a, b) => a.maps.icon.localeCompare(b.maps.icon))
---

<DiaryLayout ogType="website" title="Lieux">
	<main class="flex flex-col text-zinc-900">
		<header class="prose prose-zinc mb-8 mt-16 px-8 small:prose-sm">
			<h1>Lieux</h1>
		</header>
		<PlacesList
			title="Ã€ Toulouse"
			places={places.filter((place) => place.category == "toulouse")}
			lat={43.602}
			lng={1.446}
			zoom={13}
		/>
		<PlacesList
			title="En Occitanie"
			places={places.filter((place) => place.category == "occitanie")}
			lat={43.968}
			lng={2.562}
			zoom={7}
		/>
		<PlacesList
			title="En Aquitaine"
			places={places.filter((place) => place.category == "aquitaine")}
			lat={43.356}
			lng={-0.51}
			zoom={8}
		/>
		<PlacesList
			title="En Europe"
			places={places.filter((place) => place.category == "europe")}
			lat={47.058}
			lng={3.697}
			zoom={4}
		/>
	</main>
</DiaryLayout>

<InitMaps />
 $utils/getCollection $utils/remoteData/remoteData $utils/remoteData/googleMaps
