---
import IGDBImage from "$components/IGDBImage.astro"
import NotionPageContent from "$components/notion/NotionPageContent.astro"
import BaseLayout from "$layouts/BaseLayout.astro"
import enumerate from "$utils/enumerateStrings"
import getIGDBgame from "$utils/getIGDBgame"
import getGames from "$utils/notion/getGames"
import { emotes } from "$utils/notion/reviewEmotes"

export async function getStaticPaths() {
	const { games } = await getGames({
		and: [
			{ property: "Type", select: { equals: "Jeu" } },
			{
				property: "slug",
				rich_text: { is_not_empty: true },
			},
		],
	})
	return games.map((game) => ({
		params: { slug: game.slug },
		props: { game },
	}))
}

export interface Props {
	game: Awaited<ReturnType<typeof getGames>>["games"][number]
}
const { game } = Astro.props

const multiplayerLabels = {
	Local: "🛋️ Local",
	"En ligne": "🛜 En ligne",
	Coop: "🤝 Coop",
	Versus: "🆚 Versus",
}
const igdb = await getIGDBgame(game.slug)
---

<BaseLayout title={game.title} ogType="website" bg="white" bgDark="black">
	<div
		class="center m-auto my-8 flex justify-center gap-6 px-4 text-slate-700 dark:text-slate-300 small:flex-col"
	>
		<aside class="order-1 flex max-w-[180px] flex-col gap-2 small:order-2 small:max-w-none">
			<IGDBImage image={igdb.cover} size="cover_big" class="rounded small:hidden bg-slate-500" />
			{
				igdb.screenshots &&
					igdb.screenshots.slice(0, 2).map((screenshot) => (
						<a
							href={`https://images.igdb.com/igdb/image/upload/t_1080p/${screenshot.image_id}.jpg`}
						>
							<IGDBImage image={screenshot} size="screenshot_big" class="rounded bg-slate-500" />
						</a>
					))
			}
		</aside>
		<main class="order-2 max-w-[40ch] small:order-1">
			<div class="flex gap-4">
				<div class="hidden min-w-[70px] max-w-[70px] small:block">
					<IGDBImage image={igdb.cover} size="cover_big" class="rounded bg-slate-500" />
				</div>
				<header>
					<h1 class="text-xl text-slate-900 dark:text-slate-100">{game.title}</h1>
					<p class="text-slate-500">
						{igdb.release_dates[0].y} • {igdb.developers}{
							igdb.publishers != igdb.developers && ` • Publié par ${igdb.publishers}`
						}
					</p>
					<div class="my-3 flex gap-1">
						{
							igdb.platforms.map((p) => (
								<div class=" rounded-sm bg-slate-200 px-1 text-sm text-slate-500 dark:bg-slate-800">
									{p.abbreviation}
								</div>
							))
						}
					</div>
					{
						game.multiplayer.length > 0 && (
							<div class="my-3 flex gap-1">
								{game.multiplayer.map((string) => (
									<div class=" rounded-sm bg-slate-200 px-1 text-sm text-slate-500 dark:bg-slate-800">
										{multiplayerLabels[string]}
									</div>
								))}
							</div>
						)
					}
				</header>
			</div>
			<h2 class="mt-6 text-xl font-semibold text-slate-400 dark:text-slate-600">Mon historique</h2>
			{game.firstPlayedYear && <p>J'y ai joué pour la première fois en {game.firstPlayedYear}.</p>}
			{
				game.myPlatforms.length > 0 ? (
					<p>
						J'y ai joué sur {enumerate(game.myPlatforms)} ({game.progress}).
					</p>
				) : (
					game.progress
				)
			}
			{
				(game.quickReview || game.review) && (
					<h2 class="mt-6 text-xl font-semibold text-slate-400 dark:text-slate-600">
						Mes impressions
					</h2>
				)
			}
			{
				game.quickReview && (
					<p class="text-slate-500">
						{emotes[game.quickReview]}
						{game.quickReview}
					</p>
				)
			}
			{game.review && <p>{game.review}</p>}
			<div class="prose prose-sm prose-slate mt-3 dark:prose-invert">
				<NotionPageContent blocks={game.blocks} />
			</div>
		</main>
	</div>
</BaseLayout>

<style is:global>
	@tailwind base;
	@tailwind components;
	@tailwind utilities;
</style>
