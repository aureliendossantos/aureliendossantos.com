---
import IGDBImage from "$components/IGDBImage.astro"
import OptionalLink from "$components/OptionalLink.astro"
import FilterButton from "$components/games/FilterButton.astro"
import BaseLayout from "$layouts/BaseLayout.astro"
import type { IGDBData } from "$utils/getIGDBgame"
import getGames from "$utils/notion/getGames"
import { emotes } from "$utils/notion/reviewEmotes"

const firstResultsOnly = import.meta.env.DEV
const { games, notionResponse } = await getGames(
	{
		and: [
			{ property: "Nom", title: { is_not_empty: true } },
			{ property: "Type", select: { equals: "Jeu" } },
			{
				or: [
					{ property: "Progression", status: { does_not_equal: "Ã€ essayer" } },
					{ property: "ApprÃ©ciation", select: { is_not_empty: true } },
					{ property: "Multijoueur", multi_select: { is_not_empty: true } },
				],
			},
		],
	},
	firstResultsOnly
)

const reviewsOrder = [
	"Coup de cÅ“ur",
	"AimÃ©",
	"Sympa un moment",
	"Pas pour moi",
	"MitigÃ©",
	"Whatever",
	"DÃ©cevant",
	"J'aime pas",
	"Mauvais",
	"J'aimais",
	null,
]

games.sort(
	(a, b) =>
		reviewsOrder.indexOf(a.quickReview) - reviewsOrder.indexOf(b.quickReview) ||
		a.title.localeCompare(b.title)
)
---

<BaseLayout title="Jeux" ogType="website" bg="white" bgDark="black" font="Work Sans">
	<header class="m-auto mt-10 max-w-prose px-4">
		<h1
			class="mb-3 text-xl text-slate-900 dark:text-slate-100"
			ondblclick="window.location='https://www.notion.so/aureliendossantos/a6d5cb61551b43e4a0521b681e385729'"
		>
			Jeux auxquels j'ai jouÃ©
		</h1>
		<div class="prose prose-slate dark:prose-invert small:prose-sm">
			<p>
				Cette page recense les jeux auxquels j'ai jouÃ© et ce que j'en ai pensÃ©. Pour les jeux qui
				n'ont pas de fin, je note si j'y joue Â«Â souventÂ Â» ou Â«Â rarementÂ Â».
			</p>
			<p>
				ğŸ“ indique qu'un rapide avis Ã©crit est disponible sur la page du jeu.<br />ğŸ“– indique que le
				texte est un peu plus long.
			</p>
			<h3>Coups de cÅ“ur rÃ©cents</h3>
			<div
				class="not-prose m-auto grid max-w-prose grid-cols-6 gap-3 medium:grid-cols-5 small:grid-cols-4"
			>
				{
					games
						.filter((game) => game.igdb && game.quickReview == "Coup de cÅ“ur")
						.sort((a, b) => b.igdb!.first_release_date - a.igdb!.first_release_date)
						.slice(0, 12)
						.map((game) => (
							<a
								href={`/games/${game.slug}`}
								class="group scale-100 transition ease-out hover:scale-[1.03] medium:[&:nth-child(n+11)]:hidden small:[&:nth-child(n+9)]:hidden"
							>
								<IGDBImage
									image={game.igdb!.cover}
									size="cover_small"
									retina
									class="rounded bg-slate-500 shadow-sm transition-shadow group-hover:shadow"
									alt={game.title}
								/>
							</a>
						))
				}
			</div>
			<h3>Tous les jeux</h3>
		</div>
	</header>
	<main class="m-auto mb-10 max-w-prose">
		<div class="my-5">
			<div class="my-2 flex flex-wrap gap-2 px-4">
				<input
					class="dark:highlight-white/5 min-h-[26px] grow rounded-md px-2 text-sm caret-indigo-500 shadow-sm ring-1 ring-slate-900/10 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-slate-800 dark:ring-0 dark:focus:bg-slate-900 dark:focus:ring-2 dark:focus:ring-indigo-500"
					type="text"
					id="search-bar"
					placeholder="Rechercher un jeu"
				/>
				<div class="text-sm small:text-xs">
					<FilterButton type="checkbox" name="filters" id="all" content="Multijoueur" />
				</div>
			</div>
			<div
				class="my-2 grid w-full grid-cols-4 items-stretch gap-2 px-4 text-sm small:text-xs"
				id="filters-div"
				style="display: none;"
			>
				<FilterButton type="checkbox" name="filters" id="local" content="ğŸ›‹ï¸ Local" />
				<FilterButton type="checkbox" name="filters" id="online" content="ğŸ›œ EnÂ ligne" />
				<FilterButton type="checkbox" name="filters" id="coop" content="ğŸ¤ Coop" />
				<FilterButton type="checkbox" name="filters" id="versus" content="ğŸ†š Versus" />
			</div>
		</div>
		<table class="mb-8 w-full small:text-sm" id="games-table">
			<thead>
				<tr class="border-b border-slate-300 text-left dark:border-slate-700">
					<th colspan="2" class="py-3 pl-4">Jeu</th>
					<th>Progression</th>
					<th colspan="4">Multijoueur</th>
				</tr>
			</thead>
			<tbody class="text-slate-900 dark:text-slate-200">
				{
					games.map((item) => (
						<tr
							class="even:bg-slate-50 dark:even:bg-slate-900"
							style={{ display: item.progress == "Ã€ essayer" ? "none" : "" }}
						>
							<td
								class:list={[
									"py-3 pl-4 max-w-[26ch]",
									{
										"font-medium text-indigo-700 dark:text-indigo-400": item.igdb,
									},
								]}
							>
								<OptionalLink href={item.igdb ? `/games/${item.slug}` : undefined}>
									{item.title}
									{item.blocks.length > 0 ? "Â ğŸ“–" : item.review && "Â ğŸ“"}
								</OptionalLink>
							</td>
							<td>{emotes[item.quickReview] || item.quickReview}</td>
							<td class="text-slate-500">{item.progress}</td>
							<td>{item.multiplayer.includes("Local") && "ğŸ›‹ï¸"}</td>
							<td>{item.multiplayer.includes("En ligne") && "ğŸ›œ"}</td>
							<td>{item.multiplayer.includes("Coop") && "ğŸ¤"}</td>
							<td class="pr-4">{item.multiplayer.includes("Versus") && "ğŸ†š"}</td>
						</tr>
					))
				}
			</tbody>
		</table>
	</main>
	{/*import.meta.env.DEV && <pre>{JSON.stringify(notionResponse, null, 2)}</pre>*/}
</BaseLayout>

<script>
	const searchBar = document.getElementById("search-bar") as HTMLInputElement
	const table = document.getElementById("games-table") as HTMLTableElement
	const rows = table.getElementsByTagName("tr")
	const checkboxes = document.querySelectorAll<HTMLInputElement>("input[name=filters]")

	const getCellText = (td: HTMLTableCellElement) => td.textContent || td.innerText

	function runAllFilters() {
		const searchedText = searchBar.value.toUpperCase()
		// Loop through all table rows, and hide those who don't match the search query
		for (let i = 0; i < rows.length; i++) {
			// Here, index [0] corresponds to game names
			const td = rows[i].getElementsByTagName("td")[0]
			if (!td) continue
			if (getCellText(td).toUpperCase().indexOf(searchedText) > -1) {
				rows[i].style.display = ""
			} else {
				rows[i].style.display = "none"
			}
			// checkbox 0 is "all multiplayer games"
			// index [3] to 6 corresponds to multiplayer rows
			if (checkboxes[0].checked) {
				const multiplayerTds = [3, 4, 5, 6].map((j) => rows[i].getElementsByTagName("td")[j])
				if (multiplayerTds.filter((td) => td && getCellText(td) == "").length == 4) {
					rows[i].style.display = "none"
				}
			}
			// checkboxes 1 to 4 are multiplayer types
			// index [3] to 6 corresponds to multiplayer rows
			for (let j = 1; j <= 4; j++) {
				if (checkboxes[j].checked) {
					const td = rows[i].getElementsByTagName("td")[j + 2]
					if (getCellText(td) == "") {
						rows[i].style.display = "none"
					}
				}
			}
			// Si aucun filtre, on recache les jeux "Ã  essayer"
			if (searchBar.value == "" && Array.from(checkboxes).filter((c) => c.checked).length == 0) {
				const td = rows[i].getElementsByTagName("td")[2]
				if (getCellText(td) == "Ã€ essayer") {
					rows[i].style.display = "none"
				}
			}
		}
	}
	searchBar?.addEventListener("keyup", () => {
		runAllFilters()
	})
	checkboxes.forEach(function (checkbox) {
		checkbox.addEventListener("change", function () {
			runAllFilters()
		})
	})
	checkboxes[0].addEventListener("change", function () {
		const div = document.getElementById("filters-div") as HTMLDivElement
		if (div.style.display === "none") {
			div.style.display = ""
		} else {
			div.style.display = "none"
		}
	})
</script>

<style is:global>
	@tailwind base;
	@tailwind components;
	@tailwind utilities;
	td:not(:last-of-type) {
		@apply pr-2;
	}
</style>
