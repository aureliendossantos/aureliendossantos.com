---
import MuseumLayout from "$layouts/MuseumLayout.astro"
import { getCollection, type CollectionEntry } from "astro:content"
import Image from "$components/Image.astro"
import AudioPlayer from "$components/museum/AudioPlayer.astro"
import { getDomainName } from "$utils/formatting/formatUrl"
import { langParams, useTranslations } from "$utils/i18n"

export async function getStaticPaths() {
	const entries = await getCollection("pieces")
	return langParams.flatMap((lang) =>
		entries.map((entry) => ({
			params: { lang, piece: entry.slug },
			props: { entry, t: useTranslations(lang) },
		}))
	)
}
const { entry, t } = Astro.props
const { Content } = await entry.render()
const data = entry.data

const author = entry.slug.split("/")[0]
// Reasons for the import structure: https://github.com/rollup/plugins/tree/master/packages/dynamic-import-vars#limitations
const audio =
	data.audio && (await import(`../../../content/pieces/${author}/${data.audio}.flac`)).default
---

<MuseumLayout
	title={`${data.title} · ${data.author} · Personal Museum of Arts and Culture`}
	ogType="website"
	navBarProps={{ title: data.title || "Untitled", parent: { href: "/museum", title: "Museum" } }}
>
	<div class="relative">
		<div class="absolute py-8 mediumlarge:static" style={{ fontFamily: "InterVariable, serif" }}>
			<h2 class="text-2xl font-light">{data.title}</h2>
			<div class="text-sm">{data.author || "Unknown"}</div>
		</div>
	</div>
	{
		data.image && !data.audio && (
			<div class="flex justify-center p-8 medium:px-0">
				<Image
					src={data.image}
					alt={data.title || "Oeuvre"}
					class="max-h-[calc(100svh-64px)] w-auto"
				/>
			</div>
		)
	}
	{
		data.audio && (
			<div class="m-auto flex w-96 flex-col items-center p-8">
				{data.image && <Image src={data.image} alt="Album cover" />}
				<AudioPlayer src={audio} />
			</div>
		)
	}
	<div class="grid grid-cols-2 items-start py-16 mediumlarge:grid-cols-1 mediumlarge:text-sm">
		<div>
			<Content />
		</div>
		<table class="col-start-2 mediumlarge:col-auto">
			<tr>
				<th>Title</th>
				<td>{data.title != false ? data.title || t("m-unknown title") : t("m-untitled")}</td>
			</tr>
			<tr>
				<th>Author</th>
				<td>{data.author || t("m-unknown author")}</td>
			</tr>
			{
				data.album && (
					<tr>
						<th>Album</th>
						<td>{data.album}</td>
					</tr>
				)
			}
			<tr>
				<th>Type</th>
				<td>{data.type}</td>
			</tr>
			{
				data.technique && (
					<tr>
						<th>Technique</th>
						<td>{data.technique}</td>
					</tr>
				)
			}
			{
				data.style && (
					<tr>
						<th>Style</th>
						<td>{data.style}</td>
					</tr>
				)
			}
			<tr><th class="text-sm uppercase">Media Info</th></tr>
			{
				data.image && (
					<tr>
						<th>Image Format</th>
						<td>{data.image.format}</td>
					</tr>
				)
			}
			{
				data.audio && (
					<tr>
						<th>Audio Format</th>
						<td>flac</td>
					</tr>
				)
			}
			{
				data.fileSource && (
					<tr>
						<th>File Source</th>
						<td class="truncate">
							<a href={data.fileSource}>{getDomainName(data.fileSource)}</a>
						</td>
					</tr>
				)
			}
		</table>
	</div>
</MuseumLayout>

<style>
	th {
		font-family: "Space Mono", monospace;
		padding-right: 1em;
		@apply text-right font-normal leading-7;
	}
</style>
