{{ $isJPG := eq (path.Ext .Destination) ".jpg" }}
{{ $isPNG := eq (path.Ext .Destination) ".png" }}

{{ $alt := .PlainText | safeHTML }}
{{ $caption := "" }}
{{ with .Title }}
  {{ $caption = . | safeHTML }}
{{ end }}
{{ $url := split .Destination "#"}}

{{- $image := .Page.Resources.GetMatch (printf "%s" (.Destination | safeURL)) -}}
{{- if and $image (ne (path.Ext .Destination) ".svg") -}}
	<figure style="flex-grow: {{ div (mul $image.Width 100) $image.Height }}; flex-basis: {{ div (mul $image.Width 240) $image.Height }}px">
		<a href="{{ $image.RelPermalink }}" data-size="{{ $image.Width }}x{{ $image.Height }}">
			{{- $Permalink := $image.RelPermalink -}}
			{{- $Width := $image.Width -}}
			{{- $Height := $image.Height -}}
			{{- $Srcset := "" -}}

			{{- if and (default true .Page.Site.Params.imageProcessing.content.enabled) (gt $Width 1300) -}}
				{{- $big := $image.Resize "1300x webp" -}}
				{{- $Srcset = $big.RelPermalink -}}
			{{- end -}}
			<picture>
				{{ with $Srcset }}<source srcset="{{ . }}" type="image/webp" />{{ end }}
				<img
					src="{{ $Permalink }}"
					width="{{ $Width }}"
					height="{{ $Height }}"
					loading="lazy"
					decoding="async"
					alt="{{ if $alt }}{{ $alt }}{{ else if $caption }}{{ $caption | markdownify | plainify }}{{ else }}&nbsp;{{ end }}"
				/>
			</picture>
		</a>
		{{ with $caption }}
		<figcaption>{{ . | markdownify }}</figcaption>
		{{ end }}
	</figure>
{{- else -}}
<figure>
	<a href="{{ (index $url 0) }}" target="_blank">
		<img
			src="{{ $image.RelPermalink }}"
			decoding="async"
			loading="lazy"
			alt="{{ if $alt }}{{ $alt }}{{ else if $caption }}{{ $caption | markdownify | plainify }}{{ else }}&nbsp;{{ end }}"
		>
	</a>
	{{ with $caption }}
	<figcaption>{{ . | markdownify }}</figcaption>
	{{ end }}
</figure>
{{- end -}}

<!--

{{ $alt := .PlainText | safeHTML }}
{{ $caption := "" }}
{{ with .Title }}
  {{ $caption = . | safeHTML }}
{{ end }}

{{ $url := split .Destination "#"}}

<figure {{with (index $url 1) }}class="{{ index $url 1 }}"{{ end }}>
  <a href="{{ (index $url 0) }}" target="_blank">
    <picture>

      {{ if fileExists (path.Join "static/webp/images/" (replaceRE ".png|jpe?g" ".webp" (index $url 0))) }}
      <source type="image/webp" srcset='/{{ path.Join "webp/images/" (replaceRE ".png|jpe?g" ".webp" (index $url 0)) }}'>
      {{ end }}
      <img
        src="{{ index $url 0 }}"
        decoding="async"
        loading="lazy"
        alt="{{ if $alt }}{{ $alt }}{{ else if $caption }}{{ $caption | markdownify | plainify }}{{ else }}&nbsp;{{ end }}"
        >
      </picture>
  </a>
    {{ with $caption }}
    <figcaption>{{ . | markdownify }}</figcaption>
  {{ end }}
</figure>
-->